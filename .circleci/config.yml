version: 2.1

executors:
  kotlin-executor:
    docker:
      - image: cimg/openjdk:17.0

jobs:
  setup:
    executor: kotlin-executor
    steps:
      - checkout

      - setup_remote_docker:
          version: 20.10.7

      - run:
          name: Create initial password file for Neo4j
          command: echo "NEO4J_AUTH=neo4j/bacco4321" > initial-password.env

      - run:
          name: Start Neo4j Dev
          command: |
            docker run -d --name dev --env-file initial-password.env -p 7476:7474 -p 7689:7687 neo4j:5.12.0
            sleep 60
            docker ps -a
            docker logs dev
            docker inspect dev

      - run:
          name: Start Neo4j Test
          command: |
            docker run -d --name test --env-file initial-password.env -p 7477:7474 -p 7690:7687 neo4j:5.12.0
            sleep 60
            docker ps -a
            docker logs test
            docker inspect test

      - run:
          name: Wait for Neo4j Test to be fully up and running
          command: |
            echo "Waiting for Neo4j Test to be fully up and running..."
            for i in {1..180}; do
              if curl -s -u neo4j:bacco4321 http://localhost:7477/browser/; then
                echo "Neo4j Test is up and running."
                break
              fi
              echo "Waiting... $i"
              sleep 10
            done
            docker logs test

      - run:
          name: Verificar archivo application-test.properties
          command: cat src/test/resources/application-test.properties

      - run:
          name: Verificar archivo application.properties
          command: cat src/main/resources/application.properties

      - persist_to_workspace:
          root: /home/circleci
          paths:
            - project

  build:
    executor: kotlin-executor
    steps:
      - attach_workspace:
          at: /home/circleci

      - run:
          name: Setup environment
          command: |
            sudo apt-get update
            sudo apt-get install -y lib32stdc++6
            sudo apt-get install -y cypher-shell
            sudo apt-get upgrade

      - run:
          name: Change permissions of gradlew
          command: sudo chmod +x ./gradlew

      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "build.gradle" }}
            - v1-dependencies-

      - run:
          name: Ensure properties file exists
          command: |
            if [ ! -f src/test/resources/application-test.properties ]; then
              echo "Creating src/test/resources/application-test.properties"
              mkdir -p src/test/resources
              touch src/test/resources/application-test.properties
            fi

      - run:
          name: Update application-test.properties
          command: |
            echo "spring.neo4j.uri=bolt://localhost:7690" > src/test/resources/application-test.properties
            echo "spring.neo4j.authentication.username=neo4j" >> src/test/resources/application-test.properties
            echo "spring.neo4j.authentication.password=bacco4321" >> src/test/resources/application-test.properties
            echo "spring.servlet.multipart.max-file-size=20MB" >> src/test/resources/application-test.properties
            echo "spring.servlet.multipart.max-request-size=20MB" >> src/test/resources/application-test.properties
            echo "spring.profiles.active=test" >> src/test/resources/application-test.properties

      - run:
          name: Ensure properties file exists for dev
          command: |
            if [ ! -f src/main/resources/application.properties ]; then
              echo "Creating src/main/resources/application.properties"
              mkdir -p src/main/resources
              touch src/main/resources/application.properties
            fi

      - run:
          name: Update application-dev.properties
          command: |
            echo "spring.neo4j.uri=bolt://localhost:7689" > src/main/resources/application.properties
            echo "spring.neo4j.authentication.username=neo4j" >> src/main/resources/application.properties
            echo "spring.neo4j.authentication.password=bacco4321" >> src/main/resources/application.properties
            echo "spring.servlet.multipart.max-file-size=20MB" >> src/main/resources/application.properties
            echo "spring.servlet.multipart.max-request-size=20MB" >> src/main/resources/application.properties
            echo "spring.profiles.active=dev" >> src/main/resources/application.properties

      - run:
          name: List files before compile
          command: ls -R src/

      - run:
          name: Compile the project
          command: ./gradlew compileKotlin

      - save_cache:
          paths:
            - ~/.gradle/caches/
            - ~/.gradle/wrapper/
          key: v1-dependencies-{{ checksum "build.gradle" }}

      - persist_to_workspace:
          root: /home/circleci
          paths:
            - project

  test:
    executor: kotlin-executor
    steps:
      - attach_workspace:
          at: /home/circleci

      - run:
          name: List files after compile
          command: ls -R build/

      - run:
          name: Verify connection to Neo4j Test
          command: |
            echo "Verifying connection to Neo4j Test..."
            for i in {1..200}; do
              if curl -s -u neo4j:bacco4321 http://localhost:7477/browser/; then
                echo "Connection to Neo4j Test is successful."
                break
              fi
              echo "Waiting... $i"
              sleep 12
            done
      - run:
          name: Verify Neo4j connection with cypher-shell (Test)
          command: |
            docker exec dev cypher-shell -u neo4j -p bacco4321 -d system "RETURN 42"

      - run:
          name: Verify Neo4j connection with cypher-shell (Test)
          command: |
            docker exec test cypher-shell -u neo4j -p bacco4321 -d system "RETURN 1"

      - run:
          name: Run tests with detailed logging
          command: |
            ./gradlew test --warning-mode all --info --debug -Dorg.slf4j.simple.SimpleLogger.LEVEL=DEBUG -Dorg.springframework.core.log.LogMessage.LEVEL_TRACE

      - store_artifacts:
          path: build/reports/tests/test
          destination: test-reports

workflows:
  version: 2
  build-and-test:
    jobs:
      - setup
      - build:
          requires:
            - setup
      - test:
          requires:
            - build
